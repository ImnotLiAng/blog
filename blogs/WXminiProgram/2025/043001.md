---
title: 微信小程序架构
date: 2025/04/30
tags:
 - miniProgram
 - architecture
categories:
 - WXminiProgram
---

浏览器中根据功能大致划分为两个层面：逻辑层和渲染层

### 逻辑层
- 解析器：解析 HTML、CSS 生成 DOM 树和 CSSOM 树
- Js 引擎
- 事件处理
- 资源加载
- 布局和合成控制器：协调渲染层何时进行布局和绘制

### 渲染层
- 构建渲染树：结合 DOM 和 CSSOM
- 布局（layout）： 计算每个元素都位置
- 绘制（Paint）：将每个节点都视觉信息画到图层（生成图层绘制指令）
- 合成（Composite）：多个图层合并，最终生成位图送到 GPU 显示

在较早的版本中，浏览器采用单线程渲染架构，渲染层和逻辑层都在主线程中。
现代浏览器采用**多线程渲染架构**
将原渲染层的功能拆分为多线程
- 绘制：主线程或合成线程
- 合成：合成线程
- 栅格化（Raster）：GPU线程或栅格线程 （将图层转为位图）
- 显示（Display）： GPU线程

因为构建渲染树（样式计算）和布局依赖于 DOM 和 CSSOM，而js可以随时获取、打断或修改，因此它们只能在主线程上。


### 原生应用
原生软件的架构可以更灵活地划分逻辑层和渲染层，线程控制更加自主，不受浏览器“主线程约束”的限制，但也需要开发者手动管理线程和同步问题。
一般划分为 3 层（MVC / MVVM 等）： 逻辑-ui-渲染；视图状态变化由 ViewModel 触发
ui操作一般在 ui 线程上。
逻辑层通过延迟到下一个 UI 帧/监听布局完成等方式来获取 UI 层最新状态。


### 浏览器为什么不把样式计算和布局放到渲染线程中，然后通过延迟 UI 帧等方式获取 UI 最新状态
js 是单线程，同步执行语言，浏览器必须保证以下代码是同步准确的：
```js
div.style.width = '200px';
console.log(div.offsetWidth) // 200
```

- 浏览器厂商有义务不破坏已有大量内容：兼容性债务
将样式计算和布局放到渲染线程中，样式计算/布局异步，打破 js 的同步流程，将导致大量网站逻辑失效。

## 微信小程序架构
微信小程序与浏览器不同，逻辑层和渲染层同样在不同线程中运行，但逻辑层仅包含 js 引擎，小程序开发者的代码仅在逻辑层中运行； 渲染层为 WebView[^1]

小程序会为每一个页面创建一个WebView 线程， 逻辑层只有一个包含 js 引擎的线程，称为 App Service，发者写的所有代码最终将会打包成一份 JavaScript 文件，并在小程序启动的时候运行。
渲染层和逻辑层之间通过 native 进行通信，逻辑层发送网络请求也经由 native 转发。

[^1]: 浏览器内核容器，可以加载 HTML、CSS、JavaScript，像浏览器一样运行网页，但嵌入在 App 中，不依赖外部浏览器

在 IOS 中， 逻辑层使用的是 jsCore，渲染层为 WKWebView
在 安卓中，逻辑层使用的是 V8， 渲染层为 chromium[^2] 定制内核
小程序开发工具，逻辑层使用 NWJS，渲染层为 chrome WebView

[^2]: chromium 为 Google 主导的一个开源浏览器项目，包含 Blink 渲染引擎、V8 引擎等模块，Google Chrome、Edge、Opera 等现代浏览器的基础；Safrai 为 WebKit 渲染引擎，Firefox 为 Gecko 渲染引擎
